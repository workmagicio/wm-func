# Fairing Question & Responses æ¥å£ä½¿ç”¨è¯´æ˜

## ğŸ¯ **åŠŸèƒ½å®Œæˆæƒ…å†µ**

âœ… **å·²å®Œæˆçš„åŠŸèƒ½**ï¼š
- **Fairing Questions API** - å®Œæ•´é›†æˆï¼ˆå…¨é‡åŒæ­¥ï¼‰
- **Fairing Responses API** - å®Œæ•´é›†æˆï¼ˆåŸºäº Stream Slice çš„æ‰¹é‡å¢é‡åŒæ­¥ï¼‰  
- Airbyte æ•°æ®åº“è¡¨ç»“æ„é€‚é…
- **åŒæ¨¡å¼åŒæ­¥é€»è¾‘**ï¼šQuestionså…¨é‡ + Responses Stream Sliceæ‰¹é‡å¢é‡
- æ™ºèƒ½å˜åŒ–æ£€æµ‹æœºåˆ¶ï¼ˆQuestionsï¼‰
- **ğŸ†• åŸºäº Stream Slice çš„æ‰¹é‡åŒæ­¥**ï¼ˆResponsesï¼‰
- **ğŸ†• ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œå¤„ç†å¤šä¸ªæ—¶é—´ç‰‡æ®µ**
- **ğŸ†• å¯é…ç½®çš„ slice å¤§å°å’Œå¤„ç†æ•°é‡**
- **ğŸ†• æ™ºèƒ½è¿›åº¦ä¿å­˜å’Œæ¢å¤æœºåˆ¶**
- **ğŸ†• é¦–æ¬¡åŒæ­¥å¯æ‹‰å–ä¸€å¹´æ•°æ®**ï¼ˆä¸€æ¬¡ä»»åŠ¡å®Œæˆï¼‰
- å¤šå®ä¾‹å¹¶å‘æ”¯æŒ
- å®Œæ•´çš„æµ‹è¯•æ¨¡å¼

## ğŸ”„ **åŒæ­¥æ¨¡å¼è¯¦è§£**

### Questions API - å…¨é‡åŒæ­¥
- **ç«¯ç‚¹**: `GET https://app.fairing.co/api/questions`
- **ç‰¹æ€§**: ä¸€æ¬¡è¿”å›æ‰€æœ‰é—®é¢˜é…ç½®
- **åŒæ­¥æ–¹å¼**: å…¨é‡è·å–ï¼Œå˜åŒ–æ£€æµ‹
- **è§¦å‘æ¡ä»¶**: æ•°æ®é‡å˜åŒ–æ—¶æ‰æ›´æ–°
- **é€‚ç”¨åœºæ™¯**: é…ç½®ç±»æ•°æ®ï¼Œæ›´æ–°é¢‘ç‡ä½

### Responses API - åŸºäº Stream Slice çš„æ‰¹é‡å¢é‡åŒæ­¥ ğŸ†•
- **ç«¯ç‚¹**: `GET https://app.fairing.co/api/responses`
- **ç‰¹æ€§**: æ”¯æŒåˆ†é¡µå’Œæ—¶é—´è¿‡æ»¤ï¼ˆ`since`/`until`å‚æ•°ï¼‰
- **åŒæ­¥æ–¹å¼**: Stream Slice æ‰¹é‡å¤„ç†ï¼Œä¸€æ¬¡ä»»åŠ¡å¤„ç†å¤šä¸ªæ—¶é—´ç‰‡æ®µ
- **åˆ†é¡µæœºåˆ¶**: `after` cursor + `limit` å‚æ•°
- **Stream Slice ç­–ç•¥**: 
  - ä»»åŠ¡å¼€å§‹æ—¶åˆ›å»ºæ‰€æœ‰éœ€è¦çš„æ—¶é—´ç‰‡æ®µï¼ˆç±»ä¼¼ Airbyte è®¾è®¡ï¼‰
  - ä¸€æ¬¡ä»»åŠ¡å¾ªç¯å¤„ç†å¤šä¸ª sliceï¼ˆé»˜è®¤æœ€å¤š50ä¸ªï¼‰
  - é¦–æ¬¡åŒæ­¥ï¼šä¸€æ¬¡ä»»åŠ¡å¯å¤„ç†æ•´å¹´æ•°æ®ï¼ˆ365ä¸ªsliceï¼‰
  - å¢é‡åŒæ­¥ï¼šæ™ºèƒ½åˆ›å»ºç¼ºå¤±çš„æ—¶é—´ç‰‡æ®µ
  - è¿›åº¦ä¿å­˜ï¼šæ¯ä¸ªsliceç«‹å³ä¿å­˜çŠ¶æ€
- **æ•°æ®ä¸€è‡´æ€§ä¿éšœ**: 
  - **æ¯ä¸ªsliceç«‹å³ä¿å­˜çŠ¶æ€**ï¼šé¿å…æ•°æ®é‡å¤é—®é¢˜
  - **åŸå­æ€§æ“ä½œ**ï¼šæ•°æ®ä¿å­˜æˆåŠŸåç«‹å³æ›´æ–°åŒæ­¥çŠ¶æ€
  - **æ–­ç‚¹ç»­ä¼ **ï¼šä»»åŠ¡ä¸­æ–­åç²¾ç¡®ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
- **æ€§èƒ½ä¼˜åŒ–**: 
  - å‡å°‘é”ç«äº‰ï¼ˆä¸€æ¬¡è·å–é”å¤„ç†å¤šä¸ªsliceï¼‰
  - æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
  - å¯é…ç½®çš„å¤„ç†æ•°é‡é™åˆ¶
- **é€‚ç”¨åœºæ™¯**: äº¤æ˜“æ•°æ®ï¼ŒæŒç»­å¢é•¿

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### 1. **æµ‹è¯• Questions APIï¼ˆå…¨é‡ï¼‰**
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd cmd/fairing

# ä»…æµ‹è¯• Questions API
./deploy.sh test-questions

# æµ‹è¯•å¹¶ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
FAIRING_TEST_SAVE=true ./deploy.sh test-questions
```

### 2. **æµ‹è¯• Responses APIï¼ˆå¢é‡åˆ†é¡µï¼‰**
```bash
# å®Œæ•´APIæµ‹è¯•ï¼ˆåŒ…å«å¢é‡åˆ†é¡µæ¼”ç¤ºï¼‰
./deploy.sh test

# æµ‹è¯•å¹¶ä¿å­˜æ•°æ®
FAIRING_TEST_SAVE=true ./deploy.sh test
```

### 3. **ç”Ÿäº§ç¯å¢ƒè¿è¡Œ**
```bash
# å¯åŠ¨å¤šå®ä¾‹åŒæ­¥
./deploy.sh start

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
./deploy.sh status

# æŸ¥çœ‹å¢é‡åŒæ­¥æ—¥å¿—
./deploy.sh logs 1
```

## ğŸ“Š **API ç‰¹æ€§å¯¹æ¯”**

| ç‰¹æ€§ | Questions API | Responses API |
|------|---------------|---------------|
| **åŒæ­¥æ–¹å¼** | å…¨é‡åŒæ­¥ | å¢é‡åŒæ­¥ |
| **åˆ†é¡µæ”¯æŒ** | âŒ æ— åˆ†é¡µ | âœ… cursoråˆ†é¡µ |
| **æ—¶é—´è¿‡æ»¤** | âŒ ä¸æ”¯æŒ | âœ… since/until |
| **å“åº”æ ¼å¼** | `[]Question` | `{data: [], prev, next}` |
| **æ›´æ–°é¢‘ç‡** | æ£€æµ‹åˆ°å˜åŒ–æ—¶ | æŒç»­å¢é‡ |
| **æ•°æ®ç‰¹ç‚¹** | é…ç½®æ•°æ® | äº¤æ˜“æ•°æ® |

## ğŸ”§ **å¢é‡åŒæ­¥å‚æ•°**

### Responses API æŸ¥è¯¢å‚æ•°
```bash
GET /api/responses?since=2024-01-01T00:00:00Z&limit=100&after=ENz45Kvbxru0B5X6kDN7Y
```

- `since`: ISO8601æ—¶é—´æˆ³ï¼Œè·å–æŒ‡å®šæ—¶é—´åçš„æ•°æ®
- `limit`: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤2ï¼Œæœ€å¤§100ï¼‰
- `after`: åˆ†é¡µæ¸¸æ ‡ï¼Œè·å–æŒ‡å®šå“åº”ä¹‹åçš„æ•°æ®
- `before`: åˆ†é¡µæ¸¸æ ‡ï¼Œè·å–æŒ‡å®šå“åº”ä¹‹å‰çš„æ•°æ®

## ğŸ“ **é…ç½®è¯´æ˜**

### ç¯å¢ƒå˜é‡é…ç½® ğŸ†•
```bash
# é¦–æ¬¡åŒæ­¥å¤©æ•°é…ç½®ï¼ˆé»˜è®¤365å¤©ï¼‰
export FAIRING_INITIAL_DAYS=365

# è¿‘æœŸæ•°æ®åŒæ­¥å¤©æ•°ï¼ˆé»˜è®¤7å¤©ï¼‰
export FAIRING_RECENT_DAYS=7

# æ¯ä¸ª slice çš„å¤©æ•°ï¼ˆé»˜è®¤1å¤©ï¼‰
export FAIRING_SLICE_DAYS=1

# Stream Slice è¿è¡Œæ—¶é…ç½®
export FAIRING_MAX_SLICES_PER_RUN=800   # æ¯æ¬¡æœ€å¤šå¤„ç†800ä¸ªslice
```

### æ–°å¢é…ç½®é¡¹ ğŸ†•
```go
type FairingConfig struct {
    BatchSize         int // æ•°æ®åº“æ‰¹é‡æ’å…¥å¤§å°: 500
    ResponsesPageSize int // Responses APIæ¯é¡µå¤§å°: 100
    RateLimit         int // è¯·æ±‚é¢‘ç‡é™åˆ¶: 10 req/s
    MaxPages          int // æœ€å¤§é¡µæ•°ä¿æŠ¤: 1000
    TimeoutSecs       int // è¯·æ±‚è¶…æ—¶æ—¶é—´: 30s
    
    // Stream Slice ç›¸å…³é…ç½®
    MaxSlicesPerRun   int // æ¯æ¬¡è¿è¡Œæœ€å¤šå¤„ç†çš„sliceæ•°é‡: 800
    SliceDays         int // æ¯ä¸ªsliceçš„å¤©æ•°: 1
}
```

### åŒæ­¥çŠ¶æ€å­—æ®µ ğŸ†•
```go
type FairingSyncState struct {
    Status       string     `json:"status"`        // åŒæ­¥çŠ¶æ€
    Message      string     `json:"message"`       // çŠ¶æ€æ¶ˆæ¯
    UpdatedAt    time.Time  `json:"updated_at"`    // æ›´æ–°æ—¶é—´
    RecordCount  int64      `json:"record_count"`  // æ€»è®°å½•æ•°é‡
    LastSyncTime *time.Time `json:"last_sync_time"` // æœ€åæˆåŠŸåŒæ­¥æ—¶é—´ç‚¹
    
    // Stream Slice è¿›åº¦è¿½è¸ªï¼ˆè½»é‡çº§ï¼Œä¸å­˜å‚¨è¯¦ç»†sliceï¼‰
    SyncStartDate     *time.Time `json:"sync_start_date"`     // æœ¬è½®åŒæ­¥èµ·å§‹æ—¥æœŸ
    SyncEndDate       *time.Time `json:"sync_end_date"`       // æœ¬è½®åŒæ­¥ç»“æŸæ—¥æœŸ  
    CurrentSliceDate  *time.Time `json:"current_slice_date"`  // å½“å‰å¤„ç†åˆ°çš„æ—¥æœŸ
    CompletedSlices   int        `json:"completed_slices"`    // å·²å®Œæˆç‰‡æ®µæ•°
    TotalSlices       int        `json:"total_slices"`        // æ€»ç‰‡æ®µæ•°
    
    // åŒæ­¥é…ç½®
    InitialDays       int  `json:"initial_days"`        // é¦–æ¬¡åŒæ­¥å¤©æ•°
    IsInitialSync     bool `json:"is_initial_sync"`     // æ˜¯å¦ä¸ºé¦–æ¬¡åŒæ­¥
    RecentSyncDays    int  `json:"recent_sync_days"`    // è¿‘æœŸæ•°æ®åŒæ­¥å¤©æ•°
    SliceDays         int  `json:"slice_days"`          // æ¯ä¸ªsliceå¤©æ•°
}
```

**ğŸ’¡ è½»é‡çº§è®¾è®¡è¯´æ˜**ï¼š
- âœ… **ä¸å­˜å‚¨è¯¦ç»†çš„ slice æ•°ç»„**ï¼šé¿å… JSON å­—æ®µè¿‡å¤§
- âœ… **åªè®°å½•å…³é”®è¿›åº¦ä¿¡æ¯**ï¼šèµ·å§‹/ç»“æŸæ—¥æœŸã€å½“å‰å¤„ç†ä½ç½®ã€å®Œæˆæ•°é‡
- âœ… **è¿è¡Œæ—¶åŠ¨æ€è®¡ç®—**ï¼šæ ¹æ®å½“å‰çŠ¶æ€åŠ¨æ€ç”Ÿæˆéœ€è¦å¤„ç†çš„æ—¶é—´èŒƒå›´
- âœ… **æ•°æ®åº“å‹å¥½**ï¼šçŠ¶æ€ä¿¡æ¯å°ï¼Œåºåˆ—åŒ–å¿«ï¼Œé€‚åˆé¢‘ç¹ä¿å­˜

## ğŸ§ª **æµ‹è¯•æµç¨‹è¯¦è§£**

### 1. **Questionsæµ‹è¯•è¾“å‡º**
```
[tenant-account-question] å¼€å§‹æµ‹è¯• Questions API
[tenant-account-question] Questions APIå“åº”æˆåŠŸï¼Œè·å–æ•°é‡: 15
[tenant-account-question] æˆåŠŸå¤„ç† 15 æ¡ question æ•°æ®
  - é—®é¢˜ID: 13
  - é—®é¢˜å†…å®¹: How did you hear about us?
  - é—®é¢˜ç±»å‹: single_response
```

### 2. **Responsesæµ‹è¯•è¾“å‡º**
```
[tenant-account-response] å¼€å§‹æµ‹è¯• Responses API
[tenant-account-response] Responses APIå“åº”æˆåŠŸï¼Œæœ¬é¡µæ•°é‡: 100
[tenant-account-response] æˆåŠŸè·å–ç¬¬ä¸€é¡µæ•°æ®ï¼Œå…± 100 æ¡
[tenant-account-response] æœ‰ä¸‹ä¸€é¡µæ•°æ®: https://app.fairing.co/api/responses?after=ENz45Kvbxru0B5X6kDN7Y
  - å“åº”ID: ENz45Kvbxru0B5X6kDN7Y
  - é—®é¢˜: How did you hear about us?
  - å›ç­”: Podcast
  - å®¢æˆ·ID: 3445695217710
  - è®¢å•æ€»é¢: 57.71
```

## ğŸ“ˆ **ç”Ÿäº§ç¯å¢ƒç›‘æ§**

### QuestionsåŒæ­¥æ—¥å¿—
```
[tenant-account-question] å¼€å§‹å…¨é‡åŒæ­¥Questionsæ•°æ®
[tenant-account-question] Questionsæ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜ã€‚è®°å½•æ•°: 15
[tenant-account-question] Questionså…¨é‡åŒæ­¥å®Œæˆï¼Œå…±15æ¡è®°å½•
```

### Responseså¢é‡åŒæ­¥æ—¥å¿—
```
[tenant-account-response] å¼€å§‹å¢é‡åŒæ­¥Responsesæ•°æ®
[tenant-account-response] å¢é‡åŒæ­¥èµ·å§‹æ—¶é—´: 2024-01-15T10:30:00Z
[tenant-account-response] ç¬¬1é¡µå¤„ç†å®Œæˆï¼Œæœ¬é¡µ100æ¡ï¼Œç´¯è®¡100æ¡
[tenant-account-response] ç¬¬2é¡µå¤„ç†å®Œæˆï¼Œæœ¬é¡µ85æ¡ï¼Œç´¯è®¡185æ¡
[tenant-account-response] å·²è·å–æ‰€æœ‰é¡µé¢ï¼Œå…±2é¡µ
[tenant-account-response] Responseså¢é‡åŒæ­¥å®Œæˆï¼Œå…±185æ¡æ–°è®°å½•
```

## ğŸ” **æ•…éšœæ’æŸ¥**

### 1. **Responsesåˆ†é¡µé—®é¢˜**
```
é”™è¯¯: è§£ænext URLå¤±è´¥
è§£å†³: æ£€æŸ¥APIè¿”å›çš„nextå­—æ®µæ ¼å¼
```

### 2. **å¢é‡åŒæ­¥æ—¶é—´é—®é¢˜**
```
é”™è¯¯: sinceå‚æ•°æ ¼å¼é”™è¯¯
è§£å†³: ç¡®ä¿æ—¶é—´æ ¼å¼ä¸º RFC3339 (2006-01-02T15:04:05Z07:00)
```

### 3. **æ•°æ®é‡å¤é—®é¢˜**
```
é—®é¢˜: Responsesæ•°æ®é‡å¤æ’å…¥
è§£å†³: æ£€æŸ¥ _airbyte_raw_id å”¯ä¸€é”®çº¦æŸ
```

## âš¡ **æ€§èƒ½ä¼˜åŒ–**

### å¢é‡åŒæ­¥ä¼˜åŒ–
1. **åˆç†çš„åˆ†é¡µå¤§å°**: 100æ¡/é¡µï¼ˆAPIæœ€å¤§é™åˆ¶ï¼‰
2. **æ—¶é—´çª—å£æ§åˆ¶**: åŸºäºLastSyncTimeç²¾ç¡®å¢é‡
3. **åˆ†é¡µä¿æŠ¤**: æœ€å¤§1000é¡µé˜²æ­¢æ— é™å¾ªç¯
4. **é€Ÿç‡é™åˆ¶**: 10 req/sé¿å…APIé™åˆ¶

### æ•°æ®åº“ä¼˜åŒ–
1. **æ‰¹é‡æ’å…¥**: 500æ¡/æ‰¹æ¬¡
2. **å†²çªå¤„ç†**: åŸºäºå¤åˆä¸»é”®çš„ ON CONFLICT
3. **ç´¢å¼•ä¼˜åŒ–**: wm_tenant_id + _airbyte_raw_id

## âœ… **éªŒæ”¶æ ‡å‡†**

- [x] Questions API å…¨é‡åŒæ­¥æ­£å¸¸
- [x] Responses API å¢é‡åˆ†é¡µåŒæ­¥æ­£å¸¸
- [x] æ—¶é—´æˆ³è¿‡æ»¤åŠŸèƒ½æ­£ç¡®
- [x] åˆ†é¡µæœºåˆ¶å·¥ä½œæ­£å¸¸
- [x] æ•°æ®èƒ½æˆåŠŸä¿å­˜åˆ°å¯¹åº”è¡¨
- [x] å¤šå®ä¾‹å¹¶å‘æ— å†²çª
- [x] å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [x] é€šè¿‡æµ‹è¯•æ¨¡å¼éªŒè¯æ‰€æœ‰åŠŸèƒ½

---

**ğŸ‰ Fairing Questions & Responses æ¥å£å®Œå…¨å¯ç”¨ï¼æ”¯æŒä¸åŒæ•°æ®ç‰¹æ€§çš„æœ€ä¼˜åŒæ­¥ç­–ç•¥ï¼** 