# Fairing数据同步多实例架构

这是一个支持多实例并发运行的Fairing数据同步程序，**适配Fairing API的全量数据获取特性**，利用分布式锁机制确保多个实例之间不会产生冲突。

## 🔍 **Fairing API特性**

### API特点
- **全量数据返回**：Fairing API每次调用返回完整数据集，不支持分页
- **两个核心端点**：
  - `GET https://app.fairing.co/api/questions` - 获取所有问题
  - `GET https://app.fairing.co/api/responses` - 获取所有用户回答
- **Bearer Token认证**：使用标准的Bearer token进行API认证
- **数据变化检测**：通过记录数量变化检测是否需要更新数据

### 数据结构
- **Questions**：包含问题配置、选项、澄清问题等完整信息
- **Responses**：包含用户实际回答、订单信息、时间戳等数据
- **无分页信息**：响应不包含cursor、pageInfo等分页相关字段

## 🏗️ 架构特点

### 全量同步优化
- **智能变化检测**：通过记录数量对比，避免无意义的数据重复保存
- **一次性获取**：每次同步获取完整数据集，确保数据一致性
- **批量处理**：使用数据库批量插入优化性能
- **错误重试**：内置API调用重试机制

### 多实例并发支持
- **分布式锁机制**：使用state包提供的乐观锁，确保同一任务只能被一个实例执行
- **任务隔离**：每个账户的每种数据类型（question/response）都是独立的任务
- **自动故障恢复**：任务超过1小时自动释放锁，防止死锁
- **实例标识**：每个实例都有唯一标识，便于日志跟踪和问题排查

### 智能调度
- **任务发现**：自动发现可执行的任务
- **负载均衡**：多个实例自动分配不同的任务
- **频率控制**：避免频繁的全量同步，1小时内成功同步的任务会被跳过
- **优雅停止**：确保任务完成后才释放资源

## 📁 文件结构

```
cmd/fairing/
├── main.go         # 主程序入口，集成多实例支持
├── config.go       # 配置管理（移除分页相关配置）
├── service.go      # 核心业务逻辑和API调用（全量获取）
├── model.go        # 数据模型和数据库操作
├── types.go        # 数据结构定义（匹配真实API结构）
├── libs.go         # 工具函数和统计功能
├── query.go        # 查询相关定义
├── deploy.sh       # 多实例部署脚本
└── README.md       # 本文档
```

## 🚀 使用方法

### 环境配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `FAIRING_INSTANCES` | 3 | 运行的实例数量 |
| `FAIRING_MAX_WORKERS` | 2 | 每个实例的worker数量 |
| `FAIRING_LOG_DIR` | /tmp/fairing-logs | 日志目录 |

### API认证配置
确保在wm_account中配置正确的Fairing API Bearer Token：
```go
type Account struct {
    AccessToken string // Fairing API的Bearer Token
    // ... 其他字段
}
```

## 🔧 核心机制

### 同步状态管理
- `STATUS_SUCCESS`：同步成功
- `STATUS_RUNNING`：正在同步中  
- `STATUS_FAILED`：同步失败
- `RecordCount`：记录当前数据量，用于变化检测

### 数据变化检测
```go
// 如果记录数量没有变化，跳过数据保存
if currentCount == syncState.RecordCount {
    log.Printf("数据无变化，跳过保存。记录数: %d", currentCount)
    return nil
}
```

### API调用流程
1. **构建请求**：使用Bearer Token认证
2. **全量获取**：调用API获取完整数据
3. **数据处理**：解析JSON响应为结构化数据
4. **变化检测**：对比记录数量是否变化
5. **批量保存**：变化时才保存到数据库
6. **状态更新**：更新同步状态和记录数量

## 📊 监控和日志

### 关键日志
```
[account-trace-id] 开始全量同步数据
[account-trace-id] API响应成功，获取数据量: 150
[account-trace-id] 数据无变化，跳过保存。记录数: 150
[account-trace-id] 全量同步完成，共150条记录（上次: 148）
```

### 性能指标
- API响应时间
- 数据处理时间
- 记录数量变化
- 同步频率控制

## ⚠️ 重要注意事项

### API限制
1. **无分页支持**：Fairing API不支持分页，每次返回全量数据
2. **数据量限制**：如果数据量过大，需要考虑API响应时间
3. **频率限制**：避免过于频繁的API调用，建议间隔至少1小时

### 性能优化
1. **批量插入**：使用数据库批量操作提高性能
2. **变化检测**：只在数据有变化时才保存，减少数据库负载
3. **连接复用**：HTTP客户端连接复用
4. **合理并发**：根据数据量调整实例数量

### 故障处理
1. **API超时**：设置合理的超时时间
2. **数据解析错误**：完善错误处理和日志记录
3. **数据库连接**：确保连接池充足
4. **锁释放**：异常情况下的锁自动释放机制

## 🔮 后续优化方向

1. **增量同步**：如果Fairing未来支持时间戳过滤，可改为增量同步
2. **数据压缩**：对大量数据进行压缩存储
3. **缓存机制**：添加本地缓存减少API调用
4. **监控告警**：集成监控系统，及时发现问题
5. **容器化部署**：支持Docker和Kubernetes部署 